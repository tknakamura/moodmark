# Google Analytics 4 (GA4) 権限設定手順

## 概要
サービスアカウントにGoogle Analytics 4へのアクセス権限を付与する手順です。

## 必要な情報
- **サービスアカウントのメールアドレス**: `mood-mark-analytics@mood-mark-analytics-474807.iam.gserviceaccount.com`
- **GA4プロパティID**: `316302380`

## 設定手順

### ステップ1: Google Analyticsにアクセス
1. **Google Analytics**にアクセス
   - URL: https://analytics.google.com/
   - あなたのGoogleアカウントでログイン

### ステップ2: プロパティを選択
1. 左側のメニューから「管理」（歯車アイコン）をクリック
2. 「プロパティ」セクションで、対象のプロパティ（ID: 316302380）を選択

### ステップ3: プロパティアクセス管理を開く
1. 「プロパティアクセス管理」をクリック
2. 「+」ボタンをクリック
3. 「ユーザーを追加」を選択

### ステップ4: ユーザーを追加
1. **ユーザー**フィールドに以下を入力：
   ```
   mood-mark-analytics@mood-mark-analytics-474807.iam.gserviceaccount.com
   ```
2. **役割**を選択：
   - **推奨**: 「閲覧者」（データ取得のみ可能）
   - **または**: 「編集者」（データ取得と設定変更が可能）
3. 「追加」ボタンをクリック

## 確認方法

### 方法1: Google Analyticsで確認
1. 「管理」→「プロパティアクセス管理」を開く
2. サービスアカウントのメールアドレスがリストに表示されていることを確認
3. 役割が「閲覧者」以上であることを確認

### 方法2: ダッシュボードで確認
1. https://moodmark-csv-to-html-converter.onrender.com/analytics_chat にアクセス
2. サイドバーの「📊 Google APIs接続状態」セクションを確認
3. 「🔍 GA4接続テスト」ボタンをクリック
4. 接続成功を確認

### 方法3: 実際の分析で確認
ダッシュボードで以下の質問を実行：
```
過去30日間のトラフィック状況を教えて
```
GA4データ（セッション数、ユーザー数など）が表示されれば成功です。

## 注意事項

### 権限が反映されるまで
- 権限を付与してから、反映まで数分かかる場合があります
- すぐに反映されない場合は、数分待ってから再度テストしてください

### エラーメッセージ
- **403 Forbidden**: 権限が付与されていない、または反映されていない
- **400 Bad Request**: プロパティIDが間違っている、または無効

### トラブルシューティング
1. **サービスアカウントのメールアドレスが正しいか確認**
   - `mood-mark-analytics@mood-mark-analytics-474807.iam.gserviceaccount.com`
   - スペルミスやタイポがないか確認

2. **プロパティIDが正しいか確認**
   - GA4プロパティID: `316302380`
   - 環境変数 `GA4_PROPERTY_ID` が正しく設定されているか確認

3. **権限レベルを確認**
   - 「閲覧者」以上の権限が必要です
   - 「閲覧者」で十分です（データ取得のみ）

4. **時間を置いて再試行**
   - 権限付与後、数分待ってから再度テストしてください

## 完了後の確認

権限付与が完了したら、以下を確認してください：

1. ✅ GA4プロパティにサービスアカウントが追加されている
2. ✅ ダッシュボードでGA4接続テストが成功する
3. ✅ 実際の分析でGA4データが取得できる

## 参考リンク
- [Google Analytics ヘルプ: ユーザーと権限](https://support.google.com/analytics/answer/9303317)
- [サービスアカウントの権限設定](https://cloud.google.com/iam/docs/service-accounts)

